name: Continuous builds

on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - NAME: Packages x86_64
            RUNS_ON: ubuntu-22.04
            DOCKER_PLATFORM: linux/amd64
          # TODO: Re-enable ARM builds once x86_64 build is stable
          # - NAME: Packages aarch64
          #   RUNS_ON: ubuntu-latest-arm64
          #   DOCKER_PLATFORM: linux/arm64/v8
          # - NAME: Packages armhf
          #   RUNS_ON: ubuntu-latest-arm64
          #   DOCKER_PLATFORM: linux/arm/v7
          - NAME: Lite AppImage x86_64
            RUNS_ON: ubuntu-22.04
            DOCKER_PLATFORM: linux/amd64
            BUILD_LITE: 1
          # - NAME: Lite AppImage aarch64
          #   RUNS_ON: ubuntu-latest-arm64
          #   DOCKER_PLATFORM: linux/arm64/v8
          #   BUILD_LITE: 1
          # - NAME: Lite AppImage armhf
          #   RUNS_ON: ubuntu-latest-arm64
          #   DOCKER_PLATFORM: linux/arm/v7
          #   BUILD_LITE: 1

    name: ${{ matrix.NAME }}
    env:
      DOCKER_PLATFORM: ${{ matrix.DOCKER_PLATFORM }}
      DIST: ${{ matrix.DIST }}
      BUILD_LITE: ${{ matrix.BUILD_LITE }}
      CI: 1
    runs-on: ${{ matrix.RUNS_ON }}
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: 'recursive'

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            clang \
            g++ \
            libstdc++-dev \
            git \
            automake \
            autoconf \
            libtool \
            patch \
            wget \
            curl \
            vim-common \
            pkg-config \
            ca-certificates \
            libc6-dev \
            libc6-dev-i386 \
            libcurl4-openssl-dev \
            libfuse-dev \
            liblzma-dev \
            libglib2.0-dev \
            libcairo2-dev \
            libssl-dev \
            libbsd-dev \
            libboost-filesystem-dev \
            libarchive-dev \
            librsvg2-dev \
            librsvg2-bin \
            libgcrypt-dev \
            argagg-dev \
            nlohmann-json3-dev \
            libgpgme-dev \
            libzstd-dev \
            qtbase5-dev \
            qt5-qmake \
            qtdeclarative5-dev \
            qttools5-dev \
            qttools5-dev-tools \
            libqt5svg5-dev \
            qml-module-qtquick2 \
            qml-module-qtquick-controls2 \
            qml-module-qtquick-dialogs \
            qml-module-qtquick-layouts \
            desktop-file-utils \
            zsync \
            file \
            patchelf \
            dpkg-dev \
            rpm \
            rpm2cpio \
            qtchooser

      - name: Build project
        run: bash -ex ci/build.sh

      - name: Show build errors if failed
        if: failure()
        run: |
          echo "=== Build failed. Checking for error logs ==="
          find /dev/shm -name "*.log" 2>/dev/null || true
          find /tmp -name "CMakeError.log" 2>/dev/null -exec cat {} \; || true

      - name: Archive artifacts
        uses: actions/upload-artifact@v6
        with:
          name: build ${{ matrix.NAME }}
          path: |
              appimagelauncher*.deb*
              appimagelauncher*.rpm*
              appimagelauncher*.tar*
              appimagelauncher-lite-*.AppImage*

  upload:
    name: Create release and upload artifacts
    needs:
      - build
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v7
      - name: Inspect directory after downloading artifacts
        run: ls -alFR
      - name: Create release and upload artifacts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
          WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
          WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
          APPIMAGE_EXTRACT_AND_RUN: 1
        run: |
            wget -q https://github.com/TheAssassin/pyuploadtool/releases/download/continuous/pyuploadtool-x86_64.AppImage
            chmod +x pyuploadtool-x86_64.AppImage
            ./pyuploadtool-x86_64.AppImage **/appimagelauncher*.{deb,rpm,AppImage*}
